const sqlite=require("sqlite-sync"),$=require("jQuery"),{notas:notas,modalCategory:modalCategory,modalCriarNota:modalCriarNota,ModalEditarNota:ModalEditarNota,escapeHtml:escapeHtml,path_db:path_db}=require("../src/components/framework.js"),{remote:remote,clipboard:clipboard}=require("electron"),PATH_DB=path_db(),win=remote.getCurrentWindow();setTimeout((function(){}),500),$(document).ready((function(){function getNotesByCategoryId(category_id){sqlite.connect(PATH_DB);let rows=sqlite.run("SELECT * FROM notes AS t1 JOIN languages AS t2\n    ON t1.note_type_language = t2.lang_id WHERE note_category_id = ?\n     ORDER BY t1.created_at DESC;",[category_id]);return sqlite.close(),rows}$("#abrir-modal-criador-categoria").click((function(){setTimeout((function(){$("#category-name").focus().select()}),500)})),$("#categoria").keyup((function(){let _value=$(this);_value=_value.val();let categories=document.getElementById("category").childNodes;for(let k=0;k<categories.length;k++)categories[k].title.toLowerCase().includes(_value.toLowerCase())?$(categories[k]).removeAttr("hidden").show():$(categories[k]).removeClass("d-flex").attr("hidden",!0).hide()})),$("body").append(modalCategory("Criar nova categoria","exampleModal","idButton1"),modalCriarNota("Criar nova nota","modalCriarNota","buttonCriarNota"),ModalEditarNota("Editar Nota","modalEditarNota","btnAlterarNota")),$("#abrir-dev-tools").click((function(){remote.getCurrentWindow().toggleDevTools()})),funcSelect2("#select-tags"),$("#modalCriarNota").on("show.bs.modal",(function(event){setTimeout(()=>{$("#note-title").focus().select()},500)})),$("#idButton1").click((function(){let categoryName=$("#category-name").val().trim();if(""!=categoryName){let sql="INSERT INTO category(category_name) VALUES (?)";db.run(sql,[categoryName],(function(err){if(err)return console.error(err.message);let lastId=this.lastID;if(this.changes>0){alert("Categoria criada com sucesso!");var languages=document.getElementsByName("languages");$(languages).append(`<option value='${lastId}'>${categoryName}</option>`)}}))}})),$("#form-editar-nota").submit((function(ev){ev.preventDefault();let nota_id=document.getElementById("nota-id").value,title=this.elements["gd-title"].value,description=this.elements["gd-description"].value,tags=this.elements["gd-tags"].value,code=document.getElementById("gd-get-note"),category=document.getElementById("gd-gategory"),language=document.getElementById("gd-language");console.log(nota_id),console.log(title),console.log(description),console.log(tags),console.log(code.innerText),console.log(category[category.selectedIndex]),console.log(language[language.selectedIndex]);let sql="UPDATE notes SET note_title =?, note_description = ?, note_code = ?,\n        note_category_id = ?, note_type_language = ? WHERE  note_id = ? ";return!1})),$("#formSave").submit((function(ev){ev.preventDefault();let _this=this,title=this.elements.title.value,description=this.elements.description.value,code=this.elements.code.value,category=this.elements.languages[this.elements.languages.selectedIndex],language=this.elements["formatacao-language"][this.elements["formatacao-language"].selectedIndex];var arrInserTags=[];sqlite.connect(PATH_DB);let tags=$("#select-tags").select2("data").map((function(el){let rows=sqlite.run("SELECT tag_id, COUNT(*) AS total FROM tags WHERE tag_name = ?",[el.text.toLowerCase()]),result=rows.map(elm=>(elm.text=el.text.toLowerCase(),elm));if(rows[0].total>0)arrInserTags.push(result[0]);else{var last_insert_id=sqlite.run("INSERT INTO tags (tag_name) VALUES (?)",[el.text.toLowerCase()]);arrInserTags.push({tag_id:last_insert_id,text:el.text.toLowerCase()})}return el.text})),sql="INSERT INTO notes(note_title, note_description, note_code,\n        note_category_id, note_type_language, created_at) VALUES (?,?,?,?,?,?);";return sqlite.run(sql,[title,description,code,category.value,language.value,Date.now()],(function(id){let _lastId=id;_this.reset(),alert("Nota criada com sucesso!"),carregarCategorias(),arrInserTags.map(el=>{sqlite.connect(PATH_DB);var last_insert_id=sqlite.run("INSERT INTO note_tag (nt_note_fk_id, nt_tag_fk_id) VALUES (?, ?);",[_lastId,el.tag_id]);console.log(last_insert_id)})})),sqlite.close(),!1}));var options={content:"Some text",style:"toast",timeout:1e3};function carregarCategorias(){sqlite.connect(PATH_DB);var rows=document.getElementById("category");let result;rows.innerHTML="",sqlite.run("SELECT note_category_id, category_id, category_name, COUNT(*) as count FROM notes as t1\n      JOIN category as t2 ON t2.category_id = t1.note_category_id\n      GROUP BY note_category_id").map(row=>{let{category_id:category_id}=row;var item=document.createElement("li");item.onclick=function(){$(".list-group-item").removeClass("list-group-item-action list-group-item-success"),$(this).addClass("list-group-item-action list-group-item-success","disabled"),$("#get-notes").html('<lines class="line-30"></lines>\n        <lines class="line-30"></lines>\n        <lines class="line-30"></lines>\n        <lines class="line-30"></lines>\n        <lines class="line-30"></lines>\n        <lines class="line-30"></lines>\n        <lines class="line-30"></lines>');let rows=getNotesByCategoryId(category_id),content="";if(Object.keys(rows).length>0)for(let data of rows){sqlite.connect(PATH_DB);let rows=sqlite.run("SELECT tag_id, tag_name from tags AS t1 JOIN note_tag AS t2 ON t1.tag_id = t2.nt_tag_fk_id WHERE t2.nt_note_fk_id = ?",[data.note_id]);content+=notas(data,rows),sqlite.close()}return $("#get-notes").html(content),$(".excluir-nota").click((function(){let note_id=parseInt($(this).attr("data-nota-id")),options={type:"question",buttons:["Não","Sim"],title:"Deseja realmente excluir esta nota?",message:"Esta operação não poderá ser revertida.",detail:"Algum detalhe aqui",defaultId:0,cancelId:-1};remote.dialog.showMessageBox(win,options,response=>{1==response&&($(`#note_card_${note_id}`).remove(),sqlite.connect(PATH_DB),sqlite.runAsync("DELETE FROM notes WHERE note_id = ?;",[note_id],(function(result){console.log(result),carregarCategorias(),sqlite.close()})))})})),$(".editar-nota").click((function(){var{note_id:note_id,note_title:note_title,note_description:note_description,note_tags:note_tags,note_type_language:note_type_language}=JSON.parse($(this).attr("data-nota"));$("#modalEditarNota").modal("show"),$("#gd-title").val(note_title),$("#gd-description").val(note_description),$("#gd-tags").val(note_tags);var editor=ace.edit(document.getElementById(`note_${note_id}`));$("#gd-get-note").html(escapeHtml(editor.getValue())).addClass(note_type_language),$("#nota-id").val(note_id),$("pre code").each((function(i,e){hljs.highlightBlock(e)}))})),$(".copiar").each((function(index,element){$(this).click((function(ev){let note_id=$(this).attr("data-id");var editor=ace.edit(document.getElementById(`note_${note_id}`)),beautify;ace.require("ace/ext/beautify").beautify(editor.session),clipboard.writeText(editor.getValue());var options={content:"Código copiado com sucesso!",style:"toast",timeout:2e3};$.snackbar(options)}))})),$(".editor").each((function(i,el){var _this=$(this);let{lang_name:lang_name}=JSON.parse(_this.attr("data-note"));var editor=ace.edit(el);el.style.fontSize="16px",editor.setTheme("ace/theme/dracula"),editor.session.setMode("ace/mode/"+lang_name),editor.session.setTabSize(4),editor.resize(),editor.setOptions({autoScrollEditorIntoView:!0,copyWithEmptySelection:!0})})),$(".open-code").click((function(){var _this=$(this);let{note_id:note_id}=JSON.parse(_this.attr("data-nota"));win.webContents.send("open-new-window","ping"),window.open("ping.html","Título","myWindow")})),!1},$(item).addClass("list-group-item justify-content-between").css({borderBottom:"1px dashed #ccc",padding:"0px !important"}).html(`${row.category_name.toUpperCase()}\n   <span class='badge badge-primary badge-pill'\n    style="float:right;margin:0">${row.count}</span>`).attr("data-category",JSON.stringify(row)).attr("title",row.category_name.toUpperCase()),rows.appendChild(item)})}$.snackbar(options),carregarCategorias()}));const close=e=>{const window=remote.getCurrentWindow();window.close()};document.querySelector("#close-this-window").addEventListener("click",close);